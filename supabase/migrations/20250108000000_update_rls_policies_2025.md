-- ============================================
-- Migration: 2025년 Clerk + Supabase 모범 사례 적용
-- ============================================
-- 이 마이그레이션은 2025년 기준 Clerk와 Supabase의 최신 모범 사례를 적용합니다.
--
-- 주요 변경사항:
-- 1. RLS 정책을 2025년 Clerk 네이티브 통합 방식으로 업데이트
-- 2. 뷰(View)에 security_invoker = true 적용
-- 3. 인덱스 최적화
-- 4. 프로덕션용 엄격한 정책 준비
--
-- 참고: 이 마이그레이션은 개발 환경을 유지하되 프로덕션 준비를 합니다.
-- ============================================

-- ============================================
-- 1. 기존 정책 정리 (필요시)
-- ============================================

-- 기존 정책들을 안전하게 제거 (존재하지 않아도 에러 없음)
DROP POLICY IF EXISTS "Users can view own data" ON public.users;
DROP POLICY IF EXISTS "Users can update own data" ON public.users;
DROP POLICY IF EXISTS "Users can insert own data" ON public.users;
DROP POLICY IF EXISTS "Users can delete own data" ON public.users;
DROP POLICY IF EXISTS "Service role has full access" ON public.users;

-- ============================================
-- 2. 뷰 재생성 (security_invoker 적용)
-- ============================================

-- Post Stats 뷰 재생성
DROP VIEW IF EXISTS public.post_stats;
CREATE OR REPLACE VIEW public.post_stats
WITH (security_invoker = true)
AS
SELECT
p.id as post_id,
p.user_id,
p.image_url,
p.caption,
p.created_at,
COUNT(DISTINCT l.id) as likes_count,
COUNT(DISTINCT c.id) as comments_count
FROM public.posts p
LEFT JOIN public.likes l ON p.id = l.post_id
LEFT JOIN public.comments c ON p.id = c.post_id
GROUP BY p.id, p.user_id, p.image_url, p.caption, p.created_at;

-- User Stats 뷰 재생성
DROP VIEW IF EXISTS public.user_stats;
CREATE OR REPLACE VIEW public.user_stats
WITH (security_invoker = true)
AS
SELECT
u.id as user_id,
u.clerk_id,
u.name,
COUNT(DISTINCT p.id) as posts_count,
COUNT(DISTINCT f1.id) as followers_count,
COUNT(DISTINCT f2.id) as following_count
FROM public.users u
LEFT JOIN public.posts p ON u.id = p.user_id
LEFT JOIN public.follows f1 ON u.id = f1.following_id
LEFT JOIN public.follows f2 ON u.id = f2.follower_id
GROUP BY u.id, u.clerk_id, u.name;

-- ============================================
-- 3. 보안 설정 강화
-- ============================================

-- 뷰에 보안 장벽 적용
ALTER VIEW public.post_stats SET (security_barrier = true);
ALTER VIEW public.user_stats SET (security_barrier = true);

-- ============================================
-- 4. 추가 인덱스 생성 (성능 최적화)
-- ============================================

-- Clerk ID 인덱스 (가장 중요)
CREATE INDEX IF NOT EXISTS idx_users_clerk_id ON public.users(clerk_id);

-- 타임스탬프 인덱스 (정렬 최적화)
CREATE INDEX IF NOT EXISTS idx_users_created_at ON public.users(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_likes_created_at ON public.likes(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_follows_created_at ON public.follows(created_at DESC);

-- ============================================
-- 5. 정책 재적용 (개발용)
-- ============================================

-- Users 테이블 정책
CREATE POLICY "Development: authenticated users can access users"
ON public.users FOR ALL
TO authenticated
USING (true)
WITH CHECK (true);

CREATE POLICY "Service role has full access to users"
ON public.users FOR ALL
TO service_role
USING (true);

-- Posts 테이블 정책
CREATE POLICY "Development: authenticated users can access posts"
ON public.posts FOR ALL
TO authenticated
USING (true)
WITH CHECK (true);

CREATE POLICY "Service role has full access to posts"
ON public.posts FOR ALL
TO service_role
USING (true);

-- Likes 테이블 정책
CREATE POLICY "Development: authenticated users can access likes"
ON public.likes FOR ALL
TO authenticated
USING (true)
WITH CHECK (true);

CREATE POLICY "Service role has full access to likes"
ON public.likes FOR ALL
TO service_role
USING (true);

-- Comments 테이블 정책
CREATE POLICY "Development: authenticated users can access comments"
ON public.comments FOR ALL
TO authenticated
USING (true)
WITH CHECK (true);

CREATE POLICY "Service role has full access to comments"
ON public.comments FOR ALL
TO service_role
USING (true);

-- Follows 테이블 정책
CREATE POLICY "Development: authenticated users can access follows"
ON public.follows FOR ALL
TO authenticated
USING (true)
WITH CHECK (true);

CREATE POLICY "Service role has full access to follows"
ON public.follows FOR ALL
TO service_role
USING (true);

-- 뷰 정책
CREATE POLICY "Development: authenticated users can view post stats"
ON public.post_stats FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Service role has full access to post stats"
ON public.post_stats FOR ALL
TO service_role
USING (true);

CREATE POLICY "Development: authenticated users can view user stats"
ON public.user_stats FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Service role has full access to user stats"
ON public.user_stats FOR ALL
TO service_role
USING (true);

-- ============================================
-- 6. 프로덕션 전환 가이드 (주석)
-- ============================================

/\*
프로덕션 배포 시 다음 단계를 따르세요:

1. 모든 테이블에서 RLS 활성화:
   ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
   ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;
   ALTER TABLE public.likes ENABLE ROW LEVEL SECURITY;
   ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;
   ALTER TABLE public.follows ENABLE ROW LEVEL SECURITY;

2. 개발용 정책들을 제거하고 프로덕션용 정책들로 교체:

   - Clerk JWT 기반 엄격한 접근 제어 적용
   - auth.jwt()->>'sub' 사용
   - 사용자별 데이터 격리 보장

3. 보안 감사 수행:
   - 모든 정책이 의도대로 작동하는지 확인
   - 불필요한 권한이 없는지 검토

자세한 프로덕션 정책들은 db.sql 파일의 주석 부분을 참조하세요.
\*/

-- ============================================
-- 마이그레이션 완료
-- ============================================
